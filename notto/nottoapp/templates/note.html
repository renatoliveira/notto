<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>{{note_url}} - notto.io</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.4/quill.snow.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <meta charset="utf-8">
  <style>
  body {
    margin: 0;
    padding: 0;
  }
  form {
    margin: 0;
  }
  .notto-button-bar {
    padding: 5px;
  }
  .save-button {
    margin-left: 5px;
  }
  #editor {
    height: calc(100vh - 42px);
  }
  .ql-status {
    opacity: 0;
    transition: opacity .25s ease;
    color: orange;
  }
  .ql-status.loading {
    opacity: 1;
  }
  </style>
  <form id="mainform" action="/{{note_url}}" method="post">
</head>
<body>
    {% csrf_token %}
    <input name="content" type="hidden">
    <div id="editor"></div>
  </form>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.4/quill.min.js"></script>
  <script>
  // Underscore.js debounce
  function debounce(func, wait, immediate) {
    var timeout;
    return function() {
      var context = this, args = arguments;
      var later = function() {
        timeout = null;
        if (!immediate) func.apply(context, args);
      };
      var callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) func.apply(context, args);
    };
  };
  // Auto update
  var debounceStatus = null
  function save (status, content) {
    var http = new XMLHttpRequest();
    var url = "{{note_url}}";
    var data = new FormData();
    data.append('content', content);
    data.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    http.open("POST", url, true);
    http.onreadystatechange = function() {
      if(http.readyState == 4 && http.status == 200) {
        clearTimeout(debounceStatus);
        debounceStatus = setTimeout(function () {
          status.classList.remove('loading')
        }, 300)
      }
    };
    status.innerText = 'Loading...'
    status.classList.add('loading')
    http.send(data);
  }
  </script>
  <script>
  // reference: https://codepen.io/quill/pen/kXRjQJ
  Quill.prototype.getHtml = function () {
    return this.container.querySelector('.ql-editor').innerHTML;
  }
  Quill.prototype.setHtml = function (val) {
    return this.container.querySelector('.ql-editor').innerHTML = val;
  }
  var q = new Quill('#editor', {
    modules: {
      toolbar: {
        container: [
          [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
          ['bold', 'italic', 'underline', 'link'],
          [{ list: 'ordered' }, { list: 'bullet'}],
          ['clean', 'status']
        ],
        handlers: {
          'status': function (){}
        }
      },
    },
    theme: 'snow'
  });
  var parser = new DOMParser;
  var content = '{{content}}'
  if (content != '') {
    q.setHtml(parser.parseFromString('{{content}}', 'text/html').body.textContent);
  }
  setTimeout(function () {
    q.on('text-change', debounce(function() {
      save(document.querySelector('.ql-status'), q.getHtml());
    }, 250));
  })
  var form = document.querySelector('form');
  form.onsubmit = function () {
    var content = document.querySelector('input[name=content]');
    content.value = q.getHtml();
  };
  </script>

</body>
</html>
